<!DOCTYPE html><html>
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<script type='text/javascript' language='JavaScript' src='main.js'></script>
<link rel="stylesheet" href="sys.css">

<title>LEOPOLD</title>

<script type='text/javascript' src='http://home.lleo.me/extended/rg.js'></script>

<script>
function clean(id){ if(idd(id)) setTimeout("var s=idd('"+id+"');if(s)s.parentNode.removeChild(s);",40); }
function idd(id){ return typeof(document.getElementById(id))=='undefined'?false:document.getElementById(id); }
function idie(s){ var e=idd('buka'); e.innerHTML=e.innerHTML+s; }
function printmas(){ var s0=s1=s2='<p>',p=line.originalData,i; for(i in p[0]) { s0+=p[0][i]+','; s1+=p[1][i]+','; s2+=p[2][i]+','; } idie('<hr>'+s0+s1+s2+'<hr>'); }

STOPALL=1;
WRITEBUF=0;
ARBUF=[];

function RG(x,n){ if(STOPALL) return;
    var l;
    if(typeof x == "object" && x.length) {
	for(i=0;i<x.length;i++) { //>
	    l=x[i][0]; line.originalData[0].unshift(l); line.originalData[0].pop();
	    l=Math.min(1024, (x[i][1]*50+100) ); line.originalData[1].unshift(l); line.originalData[1].pop();
	    l=WRITEBUF*400+10; line.originalData[2].unshift(l); line.originalData[2].pop();
	} RGraph.SVG.redraw();
    }
    setTimeout("AJME("+n+")",300);
}

function RG_init(){
    NBUF=0; AJ("echo {NBUF}",function(s){x=1*s; if(!x) alert("Error NBUF: "+s); NBUF=x;});
    line=new RGraph.SVG.Line({id:'rg',
    data:[
	    RGraph.SVG.arrayFill({array:[],value:0,length:300}),
	    RGraph.SVG.arrayFill({array:[],value:0,length:300}),
	    RGraph.SVG.arrayFill({array:[],value:0,length:300})
    ],options: {
//	gutterLeft:40,
gutterTop:8,
gutterBottom:10,
gutterLeft:40,
gutterRight:20,

xaxis: false,
yaxis: false,

	yaxisMax:1024,
	yaxisMin:0,
	backgroundGridVlinesCount:100,
	backgroundGridHlinesCount:50,
	filled:[false,false,false],
	colors:['#c00','#00c','#0c0'],
	linewidth:3,
	filledColors:['rgba(255,0,0,0.25)','rgba(0,0,255,0.25)','rgba(0,255,0,0.25)'],
	shadow:true,

    textSize:'8px',
    attribution:false

    }}).draw();

//    AJAX("/MOTO?file=timstart | set.FLT 15 64 4.0 1.5");
//    AJME(0);
}

/*
function AJME(n){ n=1*(++n); if(n>=200) n=0;
    AJ("echo.buf "+n,function(x) {
	x=x.replace(/,$/g,'');
	var o=JSON.parse("["+x+"]");
	var n=o.pop();
	if(WRITEBUF && ARBUF.length <100000) for(var i in o) ARBUF.push(o[i][0]);
	RG(o,n);
    });
}
*/

LASTAJ=0;

function AJME(n){
    LASTAJ=(LASTAJ+n) & (NBUF-1);

    AJAX("/MOTO?echo.buf%20"+LASTAJ,{
        noajax:1,
        error: function(s){ setTimeout("AJME(0)",500); },
        timeout: 1000,
        ontimeout: function(s){ setTimeout("AJME(0)",500); },
        callback: function(x){
            x=x.replace(/,$/,'');
            if(x=="") return setTimeout("AJME(0)",500);
            var o=JSON.parse("["+x+"]");

            var k=0;
            for(var i in o) {
                if(WRITEBUF && ARBUF.length <100000) ARBUF.push(o[i][0]);
            }
            RG(o,n);
            setTimeout("AJME("+o.length+")",500);
        }
    });
}






































STOP1=800;
STOP2=800;
HOD1=600;
HOD2=600;

function calibrate(){
    STOPALL=1;

    line.originalData[0]=Array.from(Array(300), () => 0);
    line.originalData[1]=Array.from(Array(300), () => 0);
    line.originalData[2]=Array.from(Array(300), () => 0);
    RGraph.SVG.redraw();

    zabil('buka1','');
    var t=0;
    buka('init');
    //////////AJ("MOTORSTOP 1024 \n set MOTOROUT = 20 \n set.FLT 15 64 4.0 1.5 \n TIMER.start");
//    AJ("motor-go = 1 \n dogonka = 0 \n MaxA0 = 1024 \n MinA0 = 20 \n FltA0 = 250 \n set MaxA0.callback = \n set MinA0.callback = \n set FltA0.callback = \n set.FLT 15 64 4.0 1.5 \n TIMER.start 50");
    AJ("motor-go = 1 \n dogonka = 0 \n MaxA0 = 30000 \n MinA0 = 0 \n FltA0 = 250 \n set MaxA0.callback = \n set MinA0.callback = \n set FltA0.callback = \n set.FLT 15 64 6 1.5 \n TIMER.start 50");

    // salert("1. начать график и запустить двигатель",1000);
    t+=1; setTimeout("buka('1.0: график'); STOPALL=0; AJME(0); AJ('/MOTOR-L');" , t*1000);

    // salert("2. через 5 сек начать запись на 2 секунды, затем запустить двигатель в другую сторону",1000);
    t+=5; setTimeout(startsave,t*1000); t+=2; setTimeout("calcu(1);AJ('/MOTOR-R');",t*1000);

    // salert("3. через 2 сек (пусть раскрутится) начать запись на 2 секунды",1000);
    t+=2; setTimeout(startsave,t*1000); t+=2; setTimeout("calcu(2)",t*1000);

    // salert("4. через 5 сек (пусть снова упрется) начать запись на 2 сек и запустить двигатель обратно",1000);
    t+=5; setTimeout(startsave,t*1000); t+=2; setTimeout("calcu(3);AJ('/MOTOR-L');",t*1000);

    // salert("5. через 2 сек начать запись на 2 секунды",1000);
    t+=2; setTimeout(startsave,t*1000); t+=2; setTimeout("calcu(4)",t*1000);

    // salert("6. через 1 секунду отключить мотор и график",1000);
    t+=1; setTimeout(function(){
	buka('STOP');
	STOPALL=1;
	///////AJ("set MOTOROUT = 7 \n /MOTOR-STOP \n TIMER.stop");
	AJ("/MOTOR-STOP \n TIMER.stop");
	calcurez();
    },t*1000);
}

function buka(s){ zabil('buka1',vzyal('buka1')+'<br>'+s); }

function startsave() { ARBUF=[]; WRITEBUF=1; }

calcudoc=[];

function cpr(P) { o=''; for(var i=0;i<P[3].length;i++) {
    var c=P[3][i];
    if(c==P[2]) c='<font color=red>'+c+'</font>';
    else if(c==P[1]) c='<font color=blue>'+c+'</font>';
    o+=c+' ';
    }
    return o;
}

function calcurez(q){ alert('calcurez');
    o='<p>Заедания:';
    o+='<br>1: '+calcudoc[1][0]+' ('+calcudoc[1][1]+'...'+calcudoc[1][2]+') :'+cpr(calcudoc[1]);
    o+='<br>3: '+calcudoc[3][0]+' ('+calcudoc[3][1]+'...'+calcudoc[3][2]+') :'+cpr(calcudoc[3]);
    o+='<p>Прогоны:';
    o+='<br>2: '+calcudoc[2][0]+' ('+calcudoc[2][1]+'...'+calcudoc[2][2]+') :'+cpr(calcudoc[2]);
    o+='<br>4: '+calcudoc[4][0]+' ('+calcudoc[4][1]+'...'+calcudoc[4][2]+') :'+cpr(calcudoc[4]);

    // var M2=Math.min( calcudoc[1][1] , calcudoc[3][1] );
    var M2=Math.min( calcudoc[1][0] , calcudoc[3][0] );
    var M1=Math.max( calcudoc[2][2] , calcudoc[4][2] );

    if(M1 > M2) o+="<br><b><font color=red>калибровка не удалась: "+M1+" > "+M2+"</font><b>";
    else {
	    var rec=Math.floor( M1+ (M2-M1)*2/3  );
	    o+='<p><b>Рекомендуемый порог между '+M1+' и '+M2+' = '+rec+". Данные записаны в файл /CALIBR</b>";
	    AJ("/MOTORSTOP "+rec+" \n savefile /CALIBR MOTORSTOP "+rec,function(x){if(x=='OK') salert("Saved: /CALIBR "+rec); });
    }
    buka(o);
}

function calcu(q){
	WRITEBUF=0,o='',k=0,min=999999999,max=0;
	for(var i=0;i<ARBUF.length;i++) { var c=ARBUF[i]; k+=c; o+=c+' '; if(max<c)max=c; if(min>c) min=c;  }
	var m=Math.floor(k/ARBUF.length);
	buka('<br>'+o+'<br>итого замеров: '+ARBUF.length+'<br><b>средняя величина: '+m+' (от '+min+' до '+max+')</b><hr>');
	calcudoc[q]=[m,min,max,ARBUF];
	return m;
}

</script>

</head><body onload='RG_init();'>

<center><h1>Калибровка замка</h1></center>

<center>
<span style='background-color:#c00'>A0</span> &nbsp; &nbsp;
<span style='background-color:#00c'>FLT</span> &nbsp; &nbsp;
<span style='background-color:#0c0'>KN</span> &nbsp; &nbsp;
<span style='background-color:#0c8'>n</span>
</center>

<center><div style='width:95%;height:400px' id='rg'></div></center>

<center>
<div>
<input type=button value='LEFT' onclick="AJ('/MOTOR-L')"> &nbsp; &nbsp;
<input type=button value='STOP' onclick="AJ('/MOTOR-STOP')"> &nbsp; &nbsp;
<input type=button value='RIGHT' onclick="AJ('/MOTOR-R')">
</div>


<p><div><input type=button value='C A L I B R A T E' onclick="calibrate()"></div>

<p>
FLT_lag:       <input type=text size=5 id="FLT_lag" value='5'>
FLT_TOL:       <input type=text size=5 id="FLT_TOL" value='64'>
FLT_THRESHOLD: <input type=text size=5 id="FLT_THRESHOLD" value='3.0'>
FLT_INFLUENCE: <input type=text size=5 id="FLT_INFLUENCE" value='0.5'>
<input type=button value='SET' onclick="AJ('set.FLT '+idd('FLT_lag').value+' '+idd('FLT_TOL').value+' '+idd('FLT_THRESHOLD').value+' '+idd('FLT_INFLUENCE').value)">

</center>

<div id='buka' class=br></div>

<div id='buka1' class=r></div>

</body></html>